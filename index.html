<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Apresentação por Voz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .slide-button { width: 48px; height: 48px; border-radius: 8px; }
    .slide-button.active { border: 2px solid orange; background-color: #1f2937; }
    .circle-btn { width: 48px; height: 48px; border-radius: 9999px; font-size: 24px; }
  </style>
</head>
<body class="bg-gray-950 text-gray-100">

<div class="flex flex-col md:flex-row p-6 gap-6">
  <!-- Grade de Slides -->
  <div class="bg-gray-900 p-4 rounded-xl shadow-xl w-full md:w-1/3">
    <h2 class="text-xl font-bold text-indigo-400 mb-4">Slides</h2>
    <div id="slide-grid" class="grid grid-cols-5 gap-3"></div>
  </div>

  <!-- Painel de Navegação -->
  <div class="bg-gray-900 p-6 rounded-xl shadow-xl w-full md:w-2/3 flex flex-col justify-between">
    <div>
      <h2 class="text-xl font-bold text-indigo-400 mb-2">SLIDE ATUAL</h2>
      <div id="current-slide-box" class="bg-gray-800 p-4 rounded mb-6">
        <h3 id="current-title" class="text-yellow-300 text-2xl font-bold mb-2">Carregando...</h3>
        <p id="current-content" class="text-gray-200 text-lg">Aguardando conteúdo...</p>
      </div>

      <h2 class="text-xl font-bold text-indigo-400 mb-2">PRÓXIMO SLIDE</h2>
      <div id="next-slide-box" class="bg-gray-800 p-4 rounded">
        <h3 id="next-title" class="text-yellow-300 text-xl font-semibold mb-2">---</h3>
        <p id="next-content" class="text-gray-400 text-sm">---</p>
      </div>
    </div>

    <!-- Botões de Navegação -->
    <div class="flex justify-center gap-6 mt-6">
      <button id="prev-btn" class="circle-btn bg-gray-700 hover:bg-gray-600 text-white" disabled>←</button>
      <button id="next-btn" class="circle-btn bg-blue-500 hover:bg-blue-600 text-white" disabled>→</button>
    </div>
  </div>
</div>

<!-- Upload e Reconhecimento -->
<div class="p-6 max-w-4xl mx-auto">
  <div class="bg-gray-800 p-4 rounded mb-4">
    <input type="file" id="file-input" accept=".txt" class="block w-full text-sm text-gray-300 file:bg-indigo-500 file:text-white file:rounded-full file:px-4 file:py-2"/>
    <p class="text-xs text-gray-400 mt-2">Separe slides com linha em branco.</p>
  </div>
  <div class="flex gap-4">
    <button id="start-voice-btn" class="px-6 py-3 bg-green-500 text-white rounded hover:bg-green-600 disabled:bg-gray-400" disabled>Iniciar Reconhecimento</button>
    <button id="open-presenter-btn" class="px-6 py-3 bg-indigo-500 text-white rounded hover:bg-indigo-600">Abrir Tela do Apresentador</button>
  </div>
  <p id="voice-status" class="mt-4 text-sm text-red-400">Reconhecimento de Voz: Desligado</p>
  <p id="last-transcript" class="text-sm text-gray-400 mt-2">Última Transcrição: ---</p>
</div>

<!-- Apresentador -->
<div id="presenter-interface" class="hidden">
  <div id="presenter-screen" class="flex flex-col items-center justify-center p-10 text-white bg-black">
    <div class="max-w-6xl w-full">
      <p id="slide-index-display" class="text-3xl text-indigo-400 mb-6"></p>
      <h1 id="slide-title" class="text-7xl font-extrabold mb-10 text-yellow-300 text-center">Carregando...</h1>
      <div id="presenter-content" class="text-center text-gray-200">Aguardando...</div>
    </div>
  </div>
</div>

<script>
let slidesData = [];
let currentSlideIndex = 0;
let recognition = null;
const isPresenterMode = window.location.search.includes('mode=presenter');

function generateTrigger(text) {
  const words = text.replace(/[^\p{L}\s]/gu, "").trim().split(/\s+/);
  return words.slice(-4).join(" ") + ".";
}

function updateUI(index) {
  currentSlideIndex = index;
  const slide = slidesData[index];
  const nextSlide = slidesData[index + 1] || { title: "---", content: "---" };

  document.getElementById('current-title').textContent = slide.title;
  document.getElementById('current-content').textContent = slide.content;
  document.getElementById('next-title').textContent = nextSlide.title;
  document.getElementById('next-content').textContent = nextSlide.content;

  document.getElementById('prev-btn').disabled = (index === 0);
  document.getElementById('next-btn').disabled = (index === slidesData.length - 1);

  document.getElementById('slide-title').textContent = slide.title;
  document.getElementById('presenter-content').textContent = slide.content;
  document.getElementById('slide-index-display').textContent = `Slide ${index + 1} de ${slidesData.length}`;

  renderSlideGrid();
}

function renderSlideGrid() {
  const grid = document.getElementById('slide-grid');
  grid.innerHTML = '';
  slidesData.forEach((s, i) => {
    const btn = document.createElement('button');
    btn.className = `slide-button bg-gray-700 text-white text-sm font-bold ${i === currentSlideIndex ? 'active' : ''}`;
    btn.textContent = String(i + 1).padStart(2, '0');
    btn.onclick = () => updateUI(i);
    grid.appendChild(btn);
  });
}

function initializeSpeechRecognition() {
  if (!('webkitSpeechRecognition' in window)) {
    document.getElementById('voice-status').textContent = "ERRO: Navegador não suporta reconhecimento de voz.";
    return;
  }
  recognition = new webkitSpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = false;
  recognition.lang = 'pt-BR';

  recognition.onstart = () => document.getElementById('voice-status').textContent = "Reconhecimento de Voz: ATIVO";
  recognition.onend = () => document.getElementById('voice-status').textContent = "Reconhecimento de Voz: Desligado";
  recognition.onresult = (event) => {
    const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
    document.getElementById('last-transcript').textContent = `Última Transcrição: "${transcript}"`;
    const nextSlideIndex = currentSlideIndex + 1;
    const expectedTrigger = slidesData[nextSlideIndex]?.trigger?.toLowerCase().trim();
    if (expectedTrigger && transcript.includes(expectedTrigger)) {
      updateUI(nextSlideIndex);
    }
  };
}

document.getElementById('file-input').addEventListener('change', (event) => {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    const text = e.target.result;
    const blocks = text.split(/\n\s*\n/).filter(block => block.trim().length > 0);
    slidesData = blocks.map((content, i) => {
      const title = content.split('\n')[0].trim();
      const trigger = (i < blocks.length - 1) ? generateTrigger(content) : "";
      return { title, content: content.trim(), trigger };
    });
    updateUI(0);
    document.getElementById('start-voice-btn').disabled = false;
  };
  reader.read
