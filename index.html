<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Apresentação por Voz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #1A103A; }

    :root {
      --color-primary: #fcd34d;
      --color-background: #1A103A;
    }

    #presenter-screen {
      height: 100vh;
      width: 100vw;
      background-color: var(--color-background);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 5vh 8vw;
      box-sizing: border-box;
    }

    #slide-title {
      font-size: 60px;
      color: var(--color-primary);
      font-weight: 800;
      margin-bottom: 5vh;
      text-align: center;
      max-width: 100%;
    }

    #presenter-content {
      font-size: 60px;
      color: #E0E0E0;
      text-align: center;
      max-width: 100%;
      line-height: 1.4;
    }
  </style>
</head>
<body class="text-white">

<!-- Modo Diretor -->
<div class="p-6 max-w-4xl mx-auto">
  <h1 class="text-2xl font-bold text-yellow-400 mb-4">Modo Diretor</h1>
  <input type="file" id="file-input" accept=".txt" class="mb-4 text-sm text-gray-300 file:bg-yellow-400 file:text-black file:rounded-full file:px-4 file:py-2"/>
  <div class="flex gap-4 mb-4">
    <button id="start-voice-btn" class="px-4 py-2 bg-green-600 rounded disabled:bg-gray-600" disabled>Iniciar Voz</button>
    <button id="open-presenter-btn" class="px-4 py-2 bg-gray-500 rounded">Abrir Tela do Apresentador</button>
  </div>
  <p id="voice-status" class="text-sm text-red-400 mb-2">Voz: Desligado</p>
  <p id="last-transcript" class="text-sm text-gray-400 mb-4">Transcrição: ---</p>
  <div id="slide-grid" class="grid grid-cols-6 gap-4"></div>
</div>

<!-- Modo Apresentador -->
<div id="presenter-interface" class="hidden">
  <div id="presenter-screen">
    <h1 id="slide-title">Carregando...</h1>
    <div id="presenter-content">Aguardando sincronização...</div>
  </div>
</div>

<script>
let slidesData = [];
let currentSlideIndex = 0;
let recognition = null;
const isPresenterMode = window.location.search.includes('mode=presenter');

function generateTrigger(text) {
  const words = text.replace(/[^\p{L}\s]/gu, "").trim().split(/\s+/);
  return words.slice(-4).join(" ") + ".";
}

function updateUI(index) {
  currentSlideIndex = index;
  const slide = slidesData[index];
  document.getElementById('slide-title').textContent = slide.title;
  document.getElementById('presenter-content').textContent = slide.content;
  renderSlideGrid();
}

function renderSlideGrid() {
  const grid = document.getElementById('slide-grid');
  grid.innerHTML = '';
  slidesData.forEach((s, i) => {
    const btn = document.createElement('div');
    btn.className = `p-2 rounded bg-gray-800 cursor-pointer ${i === currentSlideIndex ? 'border-2 border-yellow-400' : ''}`;
    btn.innerHTML = `<div class="font-bold">${String(i + 1).padStart(2, '0')}</div>
                     <div class="text-sm">${s.title}</div>`;
    btn.onclick = () => updateUI(i);
    grid.appendChild(btn);
  });
}

function initializeSpeechRecognition() {
  if (!('webkitSpeechRecognition' in window)) {
    document.getElementById('voice-status').textContent = "ERRO: Navegador não suporta reconhecimento de voz.";
    return;
  }
  recognition = new webkitSpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = false;
  recognition.lang = 'pt-BR';

  recognition.onstart = () => document.getElementById('voice-status').textContent = "Voz: ATIVA";
  recognition.onend = () => document.getElementById('voice-status').textContent = "Voz: Desligado";
  recognition.onresult = (event) => {
    const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
    document.getElementById('last-transcript').textContent = `Transcrição: "${transcript}"`;
    const nextSlideIndex = currentSlideIndex + 1;
    const expectedTrigger = slidesData[nextSlideIndex]?.trigger?.toLowerCase().trim();
    if (expectedTrigger && transcript.includes(expectedTrigger)) {
      updateUI(nextSlideIndex);
    }
  };
}

document.getElementById('file-input').addEventListener('change', (event) => {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    const text = e.target.result;
    const blocks = text.split(/\n\s*\n/).filter(block => block.trim().length > 0);
    slidesData = blocks.map((content, i) => {
      const title = content.split('\n')[0].trim();
      const trigger = (i < blocks.length - 1) ? generateTrigger(content) : "";
      return { title, content: content.trim(), trigger };
    });
    updateUI(0);
    document.getElementById('start-voice-btn').disabled = true;
    if (!isPresenterMode) document.getElementById('start-voice-btn').disabled = false;
  };
  reader.readAsText(file);
});

document.getElementById('start-voice-btn').addEventListener('click', () => {
  if (!recognition) initializeSpeechRecognition();
  recognition.start();
});

document.getElementById('open-presenter-btn').addEventListener('click', () => {
  const presenterUrl = window.location.href.split('?')[0] + '?mode=presenter';
  window.open(presenterUrl, 'PresenterScreen', 'width=800,height=600,resizable=yes');
});

window.addEventListener('load', () => {
  if (isPresenterMode) {
    document.getElementById('presenter-interface').classList.remove('hidden');
  }
});
</script>
</body>
</html>
