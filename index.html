<script>
  let slides = [];
  let slideIndex = 0;
  let popupWindow = null;

  function abrirTXT() {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];
    if (!file) {
      alert('Selecione um arquivo .txt primeiro.');
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      const texto = e.target.result;
      slides = texto.split('---').map(s => s.trim()).filter(s => s.length > 0);
      mostrarMiniaturas();
      atualizarTela();
    };
    reader.readAsText(file);
  }

  function mostrarMiniaturas() {
    const container = document.getElementById('todosSlides');
    container.innerHTML = '';

    slides.forEach((slide, index) => {
      const miniatura = document.createElement('div');
      miniatura.className = 'miniatura';
      const titulo = slide.split('\n')[0] || `Slide ${index + 1}`;
      const preview = slide.length > 100 ? slide.slice(0, 100) + '...' : slide;
      miniatura.innerHTML = `<h4>${titulo}</h4><p>${preview}</p>`;
      miniatura.onclick = () => {
        slideIndex = index;
        atualizarTela();
        abrirPopup();
      };
      container.appendChild(miniatura);
    });
  }

  function atualizarTela() {
    document.getElementById('slideAtual').innerText = slides[slideIndex] || '';
    document.getElementById('proximoSlide').innerText = slides[slideIndex + 1] || '(Fim da apresentação)';
    destacarMiniatura(slideIndex);
  }

  function destacarMiniatura(index) {
    const todas = document.querySelectorAll('.miniatura');
    todas.forEach((el, i) => {
      el.classList.toggle('ativa', i === index);
    });
  }

  function abrirPopup() {
    if (popupWindow && !popupWindow.closed) {
      popupWindow.focus();
      popupWindow.postMessage({ slideIndex, slides }, '*');
      return;
    }

    popupWindow = window.open('', '', 'width=800,height=600');
    if (popupWindow) {
      popupWindow.document.write(`
        <html>
          <head>
            <title>Slide Atual</title>
            <style>
              body {
                background-color: #121212;
                color: #f0f0f0;
                font-family: Arial, sans-serif;
                padding: 40px;
                font-size: 28px;
                line-height: 1.5;
              }
            </style>
          </head>
          <body>
            <div id="conteudo"></div>
            <script>
              let slides = [];
              let slideIndex = 0;

              function atualizarSlide() {
                document.getElementById('conteudo').innerHTML = slides[slideIndex].replace(/\\n/g, '<br>');
              }

              window.addEventListener('message', function(event) {
                if (event.data.slides) {
                  slides = event.data.slides;
                  slideIndex = event.data.slideIndex;
                  atualizarSlide();
                }
              });

              document.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowRight' && slideIndex < slides.length - 1) {
                  slideIndex++;
                  atualizarSlide();
                } else if (e.key === 'ArrowLeft' && slideIndex > 0) {
                  slideIndex--;
                  atualizarSlide();
                }
              });
            <\/script>
          </body>
        </html>
      `);
      popupWindow.document.close();
      setTimeout(() => {
        popupWindow.postMessage({ slideIndex, slides }, '*');
      }, 500);
    } else {
      alert('Pop-up bloqueado. Ative pop-ups para visualizar o slide.');
    }
  }

  document.addEventListener('keydown', function(e) {
    if (slides.length === 0) return;
    if (e.key === 'ArrowRight' && slideIndex < slides.length - 1) {
      slideIndex++;
      atualizarTela();
    } else if (e.key === 'ArrowLeft' && slideIndex > 0) {
      slideIndex--;
      atualizarTela();
    }
  });
</script>
