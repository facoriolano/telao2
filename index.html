<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Apresentação por Voz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    #presenter-screen { height: 100vh; width: 100vw; }
    #presenter-content { white-space: pre-wrap; font-size: 60px; line-height: 1.3; }
    .thumbnail-item { min-width: 160px; }
    .line-clamp-2 { display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; overflow: hidden; }
  </style>
</head>
<body class="bg-gray-950 min-h-screen text-gray-100">

  <!-- Interface Diretor -->
  <div id="director-interface" class="hidden p-6 md:p-10 max-w-4xl mx-auto bg-gray-900 rounded-xl shadow-2xl">
    <h1 class="text-3xl font-bold mb-4 text-indigo-400">Modo Diretor</h1>
    <p class="mb-6 text-gray-400">Carregue slides e controle por voz.</p>

    <div class="mb-8 p-4 bg-gray-800 rounded-lg">
      <h2 class="text-xl font-semibold mb-3 text-white">Carregar Apresentação (.txt)</h2>
      <input type="file" id="file-input" accept=".txt" class="block w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-500 file:text-white hover:file:bg-indigo-600"/>
      <p class="text-xs text-gray-400 mt-2">Separe cada slide com uma linha em branco (dupla quebra de linha).</p>
    </div>

    <div class="flex items-center space-x-4 mb-8">
      <button id="open-presenter-btn" class="px-6 py-3 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">Abrir Tela do Apresentador</button>
      <button id="start-voice-btn" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:bg-gray-400" disabled>Iniciar Reconhecimento</button>
    </div>

    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
      <h2 class="text-xl font-semibold mb-3 text-gray-200">Estado</h2>
      <p id="voice-status" class="text-red-400 font-medium mb-4">Reconhecimento de Voz: Desligado</p>
      <p id="file-status" class="text-sm text-gray-400 mb-2">Arquivo .txt: N/A</p>
      <p id="current-slide-info" class="text-lg font-bold mb-2 text-white">Slide Atual: Carregando...</p>
      <p id="expected-trigger" class="text-sm text-yellow-500">Próximo gatilho: N/A</p>
      <p id="last-transcript" class="text-sm mt-2 p-2 bg-gray-700 rounded">Última Transcrição: Aguardando fala...</p>
      <p id="sync-status" class="text-xs text-gray-400 mt-2">Sincronização: aguardando apresentador...</p>
    </div>

    <div class="mt-8 pt-4 border-t border-gray-800">
      <h2 class="text-xl font-semibold mb-3 text-gray-200">Miniaturas</h2>
      <div id="thumbnails-container" class="flex flex-wrap gap-4 overflow-x-auto p-2"></div>
    </div>

    <div class="mt-8 pt-4 border-t border-gray-800">
      <h2 class="text-xl font-semibold mb-3 text-gray-200">Controle Manual</h2>
      <div class="flex space-x-3">
        <button id="prev-slide-btn" class="px-4 py-2 bg-gray-700 text-gray-100 rounded-lg hover:bg-gray-600 disabled:opacity-50" disabled>Anterior</button>
        <button id="next-slide-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50" disabled>Próximo</button>
      </div>
    </div>
  </div>

  <!-- Interface Apresentador -->
  <div id="presenter-interface" class="hidden">
    <div id="presenter-screen" class="flex flex-col items-center justify-center p-10 text-white bg-black">
      <div class="max-w-6xl w-full">
        <p id="slide-index-display" class="text-3xl font-light text-indigo-400 mb-6"></p>
        <h1 id="slide-title" class="text-7xl font-extrabold mb-10 text-center text-yellow-300">Carregando...</h1>
        <div id="presenter-content" class="text-gray-200 text-center">Aguardando...</div>
      </div>
    </div>
  </div>

  <script>
    // Estado global
    let slidesData = [];
    let currentSlideIndex = 0;
    let recognition = null;
    const isPresenterMode = window.location.search.includes('mode=presenter');

    // Canal de sincronização
    const channelName = 'voice-presenter-sync';
    const bc = ('BroadcastChannel' in window) ? new BroadcastChannel(channelName) : null;

    function broadcastState(index) {
      const payload = { type: 'slide', index };
      if (bc) {
        bc.postMessage(payload);
      } else {
        // Fallback via localStorage
        localStorage.setItem('__slide_sync__', JSON.stringify({ ts: Date.now(), ...payload }));
      }
    }

    function subscribeSync() {
      if (bc) {
        bc.onmessage = (ev) => {
          if (ev.data?.type === 'slide') {
            updateUI(Math.min(ev.data.index, slidesData.length - 1), { broadcast: false });
          }
        };
        document.getElementById('sync-status')?.textContent = 'Sincronização: canal ativo';
      } else {
        window.addEventListener('storage', (e) => {
          if (e.key === '__slide_sync__' && e.newValue) {
            try {
              const data = JSON.parse(e.newValue);
              if (data?.type === 'slide') {
                updateUI(Math.min(data.index, slidesData.length - 1), { broadcast: false });
              }
            } catch {}
          }
        });
        document.getElementById('sync-status')?.textContent = 'Sincronização: fallback via localStorage';
      }
    }

    // Utilitários
    function showError(message) {
      const el = document.getElementById('voice-status');
      el.textContent = 'ERRO: ' + message;
      el.classList.remove('text-green-500');
      el.classList.add('text-red-400');
    }

    function generateTrigger(text, wordCount = 4) {
      if (!text) return '';
      const words = text.replace(/[^\p{L}\s]/gu, '').trim().split(/\s+/);
      return words.slice(-wordCount).join(' ') + '.';
    }

    // UI
    function updateUI(index, opts = { broadcast: true }) {
      if (slidesData.length === 0) return;
      currentSlideIndex = Math.max(0, Math.min(index, slidesData.length - 1));
      const slide = slidesData[currentSlideIndex];

      // Diretor
      if (!isPresenterMode) {
        document.getElementById('current-slide-info').textContent = `Slide Atual: ${currentSlideIndex + 1} / ${slidesData.length} - ${slide.title}`;
        const nextTrigger = (currentSlideIndex < slidesData.length - 1) ? slidesData[currentSlideIndex + 1].trigger : '';
        document.getElementById('expected-trigger').textContent = nextTrigger ? `Próximo gatilho: "${nextTrigger}"` : 'Fim';
        document.getElementById('prev-slide-btn').disabled = (currentSlideIndex === 0);
        document.getElementById('next-slide-btn').disabled = (currentSlideIndex === slidesData.length - 1);
        renderThumbnails();
      }

      // Apresentador
      document.getElementById('slide-title').textContent = slide.title;
      document.getElementById('presenter-content').textContent = slide.content;
      document.getElementById('slide-index-display').textContent = `Slide ${currentSlideIndex + 1} de ${slidesData.length}`;

      if (opts.broadcast) broadcastState(currentSlideIndex);
    }

    function renderThumbnails() {
      const container = document.getElementById('thumbnails-container');
      container.innerHTML = '';
      slidesData.forEach((s, i) => {
        const thumb = document.createElement('div');
        thumb.className = `thumbnail-item p-3 border-2 rounded-lg cursor-pointer transition duration-200 w-40 h-28 flex flex-col justify-between shadow-md bg-gray-800 hover:bg-gray-700 ${i === currentSlideIndex ? 'border-indigo-400 ring-2 ring-indigo-400' : 'border-gray-700'}`;
        thumb.dataset.index = i;

        const titleEl = document.createElement('h3');
        titleEl.className = 'text-sm font-semibold truncate text-white';
        titleEl.textContent = `${i + 1}. ${s.title}`;

        const contentEl = document.createElement('p');
        contentEl.className = 'text-xs text-gray-400 overflow-hidden line-clamp-2 mt-1';
        contentEl.textContent = s.content.substring(0, 50) + (s.content.length > 50 ? '...' : '');

        const triggerEl = document.createElement('p');
        triggerEl.className = 'text-xs text-yellow-500 mt-auto';
        triggerEl.textContent = s.trigger ? `Gatilho: "${s.trigger}"` : 'FIM';

        thumb.appendChild(titleEl);
        thumb.appendChild(contentEl);
        thumb.appendChild(triggerEl);

        thumb.addEventListener('click', () => updateUI(i));
        container.appendChild(thumb);
      });
    }

    // Reconhecimento de Voz
    function initializeSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window)) {
        showError('Navegador não suporta reconhecimento de voz (use Chrome).');
        return;
      }
      recognition = new webkitSpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = false;
      recognition.lang = 'pt-BR';

      recognition.onstart = () => {
        const el = document.getElementById('voice-status');
        el.textContent = 'Reconhecimento de Voz: ATIVO. Fale agora!';
        el.classList.remove('text-red-400');
        el.classList.add('text-green-500');
      };

      recognition.onend = () => {
        const el = document.getElementById('voice-status');
        el.textContent = 'Reconhecimento de Voz: Desligado';
        el.classList.remove('text-green-500');
        el.classList.add('text-red-400');
      };

      recognition.onerror = (event) => {
        showError(`Voz: ${event.error}`);
      };

      recognition.onresult = (event) => {
        const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
        document.getElementById('last-transcript').textContent = `Última Transcrição: "${transcript}"`;

        if (currentSlideIndex < slidesData.length - 1) {
          const expected = slidesData[currentSlideIndex + 1].trigger.toLowerCase().trim();
          if (expected && transcript.includes(expected)) {
            updateUI(currentSlideIndex + 1);
          }
        }
      };
    }

    // Handlers
    document.getElementById('file-input').addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (!file) return;

      document.getElementById('file-status').textContent = `Arquivo .txt: ${file.name}`;

      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        const blocks = text.split(/\n\s*\n/).filter(block => block.trim().length > 0);

        if (blocks.length === 0) {
          showError('Nenhum slide detectado. Verifique as quebras de linha duplas.');
          return;
        }

        slidesData = blocks.map((content, index) => {
          const trimmed = content.trim();
          const firstLine = trimmed.split('\n')[0].trim();
          const title = firstLine.length < 120 ? firstLine : `Slide ${index + 1}`;
          const trigger = (index < blocks.length - 1) ? generateTrigger(trimmed) : '';
          return { title, content: trimmed, trigger };
        });

        currentSlideIndex = 0;
        updateUI(0);
        document.getElementById('start-voice-btn').disabled = false;
        document.getElementById('sync-status').textContent = 'Slides carregados. Sincronização ativa.';
      };
      reader.readAsText(file);
    });

    document.getElementById('start-voice-btn').addEventListener('click', () => {
      if (!recognition) initializeSpeechRecognition();
      try { recognition && recognition.start(); } catch {}
    });

    document.getElementById('prev-slide-btn').addEventListener('click', () => {
      if (currentSlideIndex > 0) updateUI(currentSlideIndex - 1);
    });
    document.getElementById('next-slide-btn').addEventListener('click', () => {
      if (currentSlideIndex < slidesData.length - 1) updateUI(currentSlideIndex + 1);
    });

    document.getElementById('open-presenter-btn').addEventListener('click', () => {
      const presenterUrl = window.location.href.split('?')[0] + '?mode=presenter';
      const win = window.open(presenterUrl, 'PresenterScreen', 'width=800,height=600,resizable=yes');
      if (!win) {
        document.getElementById('sync-status').textContent = 'Popup bloqueado. Abra manualmente: ' + presenterUrl;
      } else {
        document.getElementById('sync-status').textContent = 'Apresentador aberto. Sincronização ativa.';
      }
    });

    // Inicialização
    window.addEventListener('load', () => {
      subscribeSync();
      if (isPresenterMode) {
        document.getElementById('presenter-interface').classList.remove('hidden');
        document.getElementById('director-interface').classList.add('hidden');
        // Mensagem inicial no apresentador
        document.getElementById('slide-title').textContent = 'Aguardando slides...';
        document.getElementById('presenter-content').textContent = 'Abra o Modo Diretor e carregue um arquivo .txt.';
      } else {
        document.getElementById('director-interface').classList.remove('hidden');
        document.getElementById('presenter-interface').classList.add('hidden');
        // Slides de exemplo para não ficar vazio
        slidesData = [
          { title: 'Exemplo: Introdução', content: 'Bem-vindo! Carregue seu arquivo .txt para começar.', trigger: 'para começar.' },
          { title: 'Exemplo: Reconhecimento', content: 'Fale a frase final para avançar o slide automaticamente.', trigger: 'avançar o slide automaticamente.' },
          { title: 'Exemplo: Fim', content: 'Obrigado!', trigger: '' }
        ];
        updateUI(0, { broadcast: true });
      }
    });
  </script>
</body>
</html>
